.setup:
  parallel:
    matrix:
      - MPI: [openmpi, mpich]
  tags:
    - public-docker
  image: $CI_REGISTRY/conrads2/ci-images/debian/$MPI


build:
  extends: .setup
  stage: build
  script:
    - mkdir build
    - cmake -DBUILD_SHARED_LIBS=ON -B build .
    - num_cpus="$(getconf _NPROCESSORS_ONLN)"
    - echo "Building on $num_cpus CPU cores"
    - cmake --build build/ --parallel "$num_cpus"
  artifacts:
    paths:
      - build/


test:
  extends: .setup
  stage: test
  script:
    - cd build
    - ctest
